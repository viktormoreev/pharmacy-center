<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Medical History - Reports</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/custom-style.css}">
</head>
<body>
    <div th:replace="~{fragments :: navigation}"></div>

    <div class="container mt-5">
        <h1 class="mb-4">üìã Patient Medical History</h1>

        <!-- Patient Selection -->
        <div class="card mb-4">
            <div class="card-body">
                <label for="patientSelect" class="form-label">Select Patient:</label>
                <select class="form-select" id="patientSelect" onchange="loadPatientHistory()">
                    <option value="">-- Choose a patient --</option>
                    <option th:each="cust : ${customers}" 
                            th:value="${cust.id}" 
                            th:text="${cust.name + ' (EGN: ' + cust.egn + ')'}"
                            th:selected="${customer != null and customer.id == cust.id}">
                        Patient Name
                    </option>
                </select>
            </div>
        </div>

        <!-- Patient Info -->
        <div th:if="${customer != null}">
            <div class="card mb-4 border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Patient Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Name:</strong> <span th:text="${customer.name}">John Doe</span></p>
                            <p><strong>EGN:</strong> <span th:text="${customer.egn}">1234567890</span></p>
                            <p><strong>Age:</strong> <span th:text="${customer.age}">30</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Email:</strong> <span th:text="${customer.email}">john@example.com</span></p>
                            <p><strong>Phone:</strong> <span th:text="${customer.phone}">+359888123456</span></p>
                            <p><strong>Insurance Status:</strong> 
                                <span th:if="${customer.hasValidInsurance()}" class="badge bg-success">‚úì Valid</span>
                                <span th:unless="${customer.hasValidInsurance()}" class="badge bg-danger">‚úó Invalid</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Medical History -->
            <h3 class="mb-3">Medical History</h3>

            <div th:if="${history != null and !history.isEmpty()}">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Date</th>
                                <th>Doctor</th>
                                <th>Diagnosis</th>
                                <th>Status</th>
                                <th>Sick Leave</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="recipe : ${history}">
                                <td th:text="${#temporals.format(recipe.creationDate, 'dd-MM-yyyy')}">01-01-2026</td>
                                <td th:text="${recipe.doctor.name}">Dr. Smith</td>
                                <td th:text="${recipe.diagnosis}">Flu</td>
                                <td>
                                    <span class="badge" 
                                          th:classappend="${recipe.status == T(com.inf.cscb869_pharmacy.recipe.entity.RecipeStatus).ACTIVE ? 'bg-success' : 'bg-secondary'}"
                                          th:text="${recipe.status}">ACTIVE</span>
                                </td>
                                <td>
                                    <span th:if="${recipe.sickLeave}" class="badge bg-warning text-dark">
                                        <span th:text="${recipe.sickLeaveDays}">3</span> days
                                        (from <span th:text="${#temporals.format(recipe.sickLeaveStartDate, 'dd-MM-yyyy')}">01-01-2026</span>)
                                    </span>
                                    <span th:unless="${recipe.sickLeave}" class="text-muted">-</span>
                                </td>
                                <td th:text="${recipe.notes ?: '-'}">Notes</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div th:if="${history == null or history.isEmpty()}" class="alert alert-info">
                No medical history available for this patient.
            </div>
        </div>

        <div class="mt-4">
            <a th:href="@{/reports}" class="btn btn-secondary">‚Üê Back to Reports</a>
        </div>
    </div>

    <script th:src="@{/js/jquery-3.5.1.min.js}"></script>
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script>
        function loadPatientHistory() {
            const patientId = document.getElementById('patientSelect').value;
            if (patientId) {
                window.location.href = '/reports/patient-history/' + patientId;
            }
        }
    </script>
</body>
</html>
