<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments :: head}"></head>
<body>
<header th:replace="~{fragments :: header}"></header>
<nav th:replace="~{fragments :: navigation}"></nav>

<div class="container my-5">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-5">
            <i class="bi bi-file-medical-fill"></i> Prescription Details
        </h1>
        <div>
            <a th:href="@{/recipes}" class="btn btn-secondary me-2">
                <i class="bi bi-arrow-left"></i> Back to List
            </a>
            <a th:href="@{/recipes/edit/{id}(id=${recipe.id})}" 
               class="btn btn-primary"
               sec:authorize="hasAnyRole('DOCTOR', 'ADMIN')">
                <i class="bi bi-pencil"></i> Edit
            </a>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle"></i> <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle"></i> <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="row g-4">
        <!-- Basic Information -->
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Basic Information</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-sm-5"><strong>Prescription ID:</strong></div>
                        <div class="col-sm-7" th:text="${recipe.id}">1</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-5"><strong>Creation Date:</strong></div>
                        <div class="col-sm-7" th:text="${#temporals.format(recipe.creationDate, 'MMM dd, yyyy')}">Jan 15, 2026</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-5"><strong>Status:</strong></div>
                        <div class="col-sm-7">
                            <span class="badge fs-6" 
                                  th:classappend="${recipe.status != null && recipe.status.name() == 'ACTIVE'} ? 'bg-success' : 
                                                  (${recipe.status != null && recipe.status.name() == 'FULFILLED'} ? 'bg-primary' : 
                                                  (${recipe.status != null && recipe.status.name() == 'EXPIRED'} ? 'bg-danger' : 'bg-secondary'))"
                                  th:text="${recipe.status != null ? recipe.status : 'UNKNOWN'}">
                                ACTIVE
                            </span>
                        </div>
                    </div>
                    <div class="row mb-3" th:if="${recipe.expirationDate != null}">
                        <div class="col-sm-5"><strong>Expiration Date:</strong></div>
                        <div class="col-sm-7">
                            <span th:text="${#temporals.format(recipe.expirationDate, 'MMM dd, yyyy')}">Feb 15, 2026</span>
                            <span th:if="${recipe.expired}" class="badge bg-danger ms-2">Expired</span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-5"><strong>Doctor:</strong></div>
                        <div class="col-sm-7" th:text="${recipe.doctor != null ? recipe.doctor.name : 'N/A'}">Dr. Smith</div>
                    </div>
                    <div class="row">
                        <div class="col-sm-5"><strong>Customer:</strong></div>
                        <div class="col-sm-7">
                            <a th:if="${recipe.customer != null}"
                               th:href="@{/customers/{id}(id=${recipe.customer.id})}" 
                               th:text="${recipe.customer.name}"
                               class="text-decoration-none">
                                John Doe
                            </a>
                            <span th:if="${recipe.customer == null}" class="text-muted">N/A</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Medical Information -->
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-heart-pulse"></i> Medical Information</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Diagnosis:</strong>
                        <p class="mt-2" th:if="${recipe.diagnosisSummary != null && !recipe.diagnosisSummary.isEmpty()}" 
                           th:text="${recipe.diagnosisSummary}">
                            Patient diagnosis text...
                        </p>
                        <p class="mt-2 text-muted fst-italic" th:if="${recipe.diagnosisSummary == null || recipe.diagnosisSummary.isEmpty()}">
                            No diagnosis provided
                        </p>
                    </div>
                    <div>
                        <strong>Notes:</strong>
                        <p class="mt-2" th:if="${recipe.notes != null && !recipe.notes.isEmpty()}" 
                           th:text="${recipe.notes}">
                            Additional notes from doctor...
                        </p>
                        <p class="mt-2 text-muted fst-italic" th:if="${recipe.notes == null || recipe.notes.isEmpty()}">
                            No additional notes
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Prescribed Medicines -->
    <div class="card shadow-sm mt-4">
        <div class="card-header bg-info text-dark">
            <h5 class="mb-0"><i class="bi bi-capsule"></i> Prescribed Medicines</h5>
        </div>
        <div class="card-body">
            <div th:if="${recipe.recipeMedicines != null && !recipe.recipeMedicines.isEmpty()}" class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Medicine</th>
                            <th>Dosage</th>
                            <th>Duration</th>
                            <th>Quantity</th>
                            <th>Instructions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="rm, iterStat : ${recipe.recipeMedicines}">
                            <td th:text="${iterStat.count}">1</td>
                            <td>
                                <strong th:text="${rm.medicine != null ? rm.medicine.name : 'Unknown medicine'}">Medicine Name</strong>
                                <br>
                                <small class="text-muted" th:if="${rm.medicine != null}">
                                    Age: <span th:text="${rm.medicine.ageAppropriateness}">18+</span> |
                                    <span th:if="${rm.medicine.needsRecipe}" class="badge bg-warning text-dark">Prescription Required</span>
                                    <span th:if="${!rm.medicine.needsRecipe}" class="badge bg-success">OTC</span>
                                </small>
                                <small class="text-muted" th:if="${rm.medicine == null}">Medicine record missing</small>
                            </td>
                            <td th:text="${rm.dosage}">2 tablets</td>
                            <td>
                                <span th:text="${rm.durationDays}">7</span> days
                            </td>
                            <td th:text="${rm.quantity}">30</td>
                            <td>
                                <span th:if="${rm.instructions != null && !rm.instructions.isEmpty()}" 
                                      th:text="${rm.instructions}">
                                    Take with food
                                </span>
                                <span th:if="${rm.instructions == null || rm.instructions.isEmpty()}" 
                                      class="text-muted fst-italic">
                                    No instructions
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div th:if="${recipe.recipeMedicines == null || recipe.recipeMedicines.isEmpty()}" 
                 class="text-center py-4">
                <i class="bi bi-exclamation-circle text-warning" style="font-size: 3rem;"></i>
                <p class="text-muted mt-3">No medicines prescribed</p>
            </div>
        </div>
    </div>
</div>

<footer th:replace="~{fragments :: footer}"></footer>
</body>
</html>
